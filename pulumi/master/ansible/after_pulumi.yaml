---
- hosts: localhost
  vars:
    keypair_path: '~/.ssh/hhk7734.pem'
    pod_network_cidr: '10.235.0.0'
  tasks:
    - name: gather EC2 instance public IP created by Pulumi
      shell: pulumi stack output -j
      register: pulumi_stack_output

    - set_fact:
        pulumi_info: '{{ pulumi_stack_output.stdout | from_json }}'

    - debug:
        msg:
          - 'The public IP of the Pulumi created EC2 instance is: {{ pulumi_info.k8s_master_0_public_ip }}'
          - 'The private IP of the Pulumi created EC2 instance is: {{ pulumi_info.k8s_master_0_private_ip }}'

    - name: wait 300 seconds for port 22 to become open and contain "SSH" - then the SSH connection should work afterwards
      wait_for:
        port: 22
        host: '{{ pulumi_info.k8s_master_0_public_ip }}'
        search_regex: SSH
        delay: 10
        timeout: 320

    - name: setup docker
      become: true
      delegate_to: '{{ pulumi_info.k8s_master_0_public_ip }}'
      delegate_facts: true
      vars:
        ansible_ssh_private_key_file: '{{ keypair_path }}'
        ansible_user: ubuntu
      import_role:
        name: docker

    - name: setup kubeadm
      become: true
      delegate_to: '{{ pulumi_info.k8s_master_0_public_ip }}'
      delegate_facts: true
      vars:
        ansible_ssh_private_key_file: '{{ keypair_path }}'
        ansible_user: ubuntu
      import_role:
        name: kubeadm

    - name: setup calico
      delegate_to: '{{ pulumi_info.k8s_master_0_public_ip }}'
      delegate_facts: true
      vars:
        ansible_ssh_private_key_file: '{{ keypair_path }}'
        ansible_user: ubuntu
      import_role:
        name: calico
