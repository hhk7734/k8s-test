---
- name: kubectl create -f tigera-operator
  shell: kubectl create -f https://docs.projectcalico.org/manifests/tigera-operator.yaml >> tigera-operator.log
  args:
    chdir: /home/{{ ansible_user }}
    creates: tigera-operator.log

- name: create calico.yaml
  delegate_to: localhost
  copy:
    dest: '{{ playbook_dir }}/k8s/calico.yaml'
    content: |
      # This section includes base Calico installation configuration.
      # For more information, see: https://docs.projectcalico.org/v3.19/reference/installation/api#operator.tigera.io/v1.Installation
      apiVersion: operator.tigera.io/v1
      kind: Installation
      metadata:
        name: default
      spec:
        # Configures Calico networking.
        calicoNetwork:
          # Note: The ipPools section cannot be modified post-install.
          ipPools:
            - blockSize: 26
              cidr: {{ pod_network_cidr}}/16
              encapsulation: VXLANCrossSubnet
              natOutgoing: Enabled
              nodeSelector: all()
    mode: 0644

- name: copy calico.yaml from localhost
  copy:
    src: '{{ playbook_dir }}/k8s/calico.yaml'
    dest: /home/{{ ansible_user }}/calico.yaml
    mode: 0644

- name: kubectl create -f calico.yaml
  shell: kubectl create -f /home/{{ ansible_user }}/calico.yaml >> calico.log
  args:
    chdir: /home/{{ ansible_user }}
    creates: calico.log
